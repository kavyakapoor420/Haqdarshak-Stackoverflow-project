<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarvam AI & Gemini Voice Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #4c63d2 0%, #6366f1 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.5; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            font-size: 1rem;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .message.bot .message-content {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .message.user .avatar {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }

        .message.bot .avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .controls {
            padding: 30px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .api-key-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-key-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(239, 68, 68, 0.4);
        }

        .record-btn.recording {
            animation: recordingPulse 1s ease-in-out infinite;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .record-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            animation: ripple 2s ease-out infinite;
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .voice-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }

        .select-group {
            display: flex;
            gap: 10px;
        }

        .select {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.3s ease;
        }

        .select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .status {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status.info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .status.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .status.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease-out;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
            animation: typingBounce 1.5s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .audio-player {
            margin-top: 10px;
            width: 100%;
        }

        .audio-player audio {
            width: 100%;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .voice-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .record-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                align-self: center;
            }

            .select-group {
                flex-direction: column;
            }

            .message-content {
                max-width: 85%;
            }
        }

        @media (prefers-color-scheme: dark) {
            .chat-container {
                background: #1f2937;
            }

            .message.bot .message-content {
                background: #374151;
                color: #f9fafb;
                border-color: #4b5563;
            }

            .controls {
                background: #1f2937;
            }

            .api-key-input, .select {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎙️ Sarvam AI & Gemini Voice Bot</h1>
            <p>Speak naturally and get intelligent responses powered by Google Gemini</p>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot">
                <div class="avatar">🤖</div>
                <div class="message-content">
                    Hello! I'm your AI voice assistant powered by Sarvam AI and Google Gemini. Speak in multiple Indian languages or English, and I'll respond naturally. Please enter your Sarvam AI and Gemini API keys to start!
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="api-key-container">
                <input 
                    type="password" 
                    id="sarvamApiKey" 
                    class="api-key-input" 
                    placeholder="Enter your Sarvam AI API Subscription Key"
                    autocomplete="off"
                >
                <input 
                    type="password" 
                    id="geminiApiKey" 
                    class="api-key-input" 
                    placeholder="Enter your Google Gemini API Key"
                    autocomplete="off"
                >
                <button class="btn btn-secondary" onclick="saveApiKeys()">Save Keys</button>
            </div>

            <div class="voice-controls">
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    🎤
                </button>
                
                <div class="voice-options">
                    <div class="select-group">
                        <select class="select" id="languageSelect">
                            <option value="hi-IN">Hindi (हिंदी)</option>
                            <option value="en-IN">English (India)</option>
                            <option value="bn-IN">Bengali (বাংলা)</option>
                            <option value="ta-IN">Tamil (தமிழ்)</option>
                            <option value="te-IN">Telugu (తెలుగు)</option>
                            <option value="ml-IN">Malayalam (മലയാളം)</option>
                            <option value="kn-IN">Kannada (ಕನ್ನಡ)</option>
                            <option value="gu-IN">Gujarati (ગુજરાતી)</option>
                            <option value="pa-IN">Punjabi (ਪੰਜਾਬੀ)</option>
                        </select>
                        
                        <select class="select" id="speakerSelect">
                            <option value="anushka">Anushka (Female)</option>
                            <option value="manisha">Manisha (Female)</option>
                            <option value="vidya">Vidya (Female)</option>
                            <option value="arya">Arya (Female)</option>
                            <option value="abhilash">Abhilash (Male)</option>
                            <option value="karun">Karun (Male)</option>
                            <option value="hitesh">Hitesh (Male)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="status info" id="status">
                Ready to chat! Enter API keys and click the microphone to start speaking.
            </div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let sarvamApiKey = '';
        let geminiApiKey = '';

        // Initialize the app
        function init() {
            const savedSarvamApiKey = localStorage.getItem('sarvam_api_key');
            const savedGeminiApiKey = localStorage.getItem('gemini_api_key');
            if (savedSarvamApiKey) {
                document.getElementById('sarvamApiKey').value = savedSarvamApiKey;
                sarvamApiKey = savedSarvamApiKey;
            }
            if (savedGeminiApiKey) {
                document.getElementById('geminiApiKey').value = savedGeminiApiKey;
                geminiApiKey = savedGeminiApiKey;
            }
            if (savedSarvamApiKey && savedGeminiApiKey) {
                updateStatus('API keys loaded. Ready to chat!', 'success');
            }
        }

        // Save API keys
        function saveApiKeys() {
            const sarvamKeyInput = document.getElementById('sarvamApiKey');
            const geminiKeyInput = document.getElementById('geminiApiKey');
            let isValid = true;

            if (sarvamKeyInput.value.trim()) {
                sarvamApiKey = sarvamKeyInput.value.trim();
                localStorage.setItem('sarvam_api_key', sarvamApiKey);
            } else {
                updateStatus('Please enter a valid Sarvam AI API key', 'error');
                isValid = false;
            }

            if (geminiKeyInput.value.trim()) {
                geminiApiKey = geminiKeyInput.value.trim();
                localStorage.setItem('gemini_api_key', geminiApiKey);
            } else {
                updateStatus('Please enter a valid Google Gemini API key', 'error');
                isValid = false;
            }

            if (isValid) {
                updateStatus('API keys saved successfully!', 'success');
            }
        }

        // Update status message
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // Toggle recording
        async function toggleRecording() {
            if (!sarvamApiKey || !geminiApiKey) {
                updateStatus('Please enter and save both API keys first', 'error');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.add('recording');
                recordBtn.textContent = '⏹️';
                
                updateStatus('Recording... Click to stop', 'warning');
                
            } catch (error) {
                console.error('Error starting recording:', error);
                updateStatus('Error accessing microphone. Please check permissions.', 'error');
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.classList.remove('recording');
                recordBtn.textContent = '🎤';
                
                updateStatus('Processing audio...', 'info');
            }
        }

        // Process audio with Sarvam AI and Gemini
        async function processAudio(audioBlob) {
            try {
                // Step 1: Transcribe audio using Sarvam AI
                const transcription = await speechToText(audioBlob);
                
                if (!transcription || !transcription.transcript) {
                    updateStatus('Could not understand the audio. Please try again.', 'error');
                    return;
                }

                // Display user message
                addMessage(transcription.transcript, 'user');
                
                // Step 2: Generate response using Google Gemini
                const aiResponse = await generateAIResponse(transcription.transcript);
                
                // Step 3: Convert response to speech using backend
                const audioData = await textToSpeech(aiResponse);
                
                // Display and play bot response
                addMessage(aiResponse, 'bot', audioData);
                
                updateStatus('Response generated successfully!', 'success');
                
            } catch (error) {
                console.error('Error processing audio:', error);
                updateStatus('Error processing audio. Please try again.', 'error');
            }
        }

        // Speech to text using Sarvam AI
        async function speechToText(audioBlob) {
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.wav');
            formData.append('model', 'saarika:v2.5');
            formData.append('language_code', 'unknown');

            const response = await fetch('https://api.sarvam.ai/speech-to-text', {
                method: 'POST',
                headers: {
                    'api-subscription-key': sarvamApiKey
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Speech-to-text API error: ${response.status}`);
            }

            return await response.json();
        }

        // Generate AI response using Google Gemini API
        async function generateAIResponse(userText) {
            showTypingIndicator();
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: userText
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }

                const data = await response.json();
                const textResponse = data.candidates[0].content.parts[0].text;

                return textResponse || 'Sorry, I couldn’t generate a response. Please try again.';
            } catch (error) {
                console.error('Error with Gemini API:', error);
                return 'Error generating response from Gemini. Please check your API key or try again later.';
            } finally {
                // Simulate processing delay for UX
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // Text to speech using FastAPI backend
        async function textToSpeech(text) {
            const languageCode = document.getElementById('languageSelect').value;
            const speaker = document.getElementById('speakerSelect').value;

            try {
                const response = await fetch('http://localhost:8000/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        target_language_code: languageCode,
                        speaker: speaker
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend text-to-speech API error: ${response.status}`);
                }

                const data = await response.json();
                return data.audio;
            } catch (error) {
                console.error('Error with backend text-to-speech:', error);
                throw new Error('Failed to generate speech. Please try again.');
            }
        }

        // Add message to chat
        function addMessage(text, sender, audioData = null) {
            const chatContainer = document.getElementById('chatContainer');
            
            const typingIndicator = chatContainer.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = sender === 'user' ? '👤' : '🤖';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = text;
            
            if (sender === 'bot' && audioData) {
                const audioPlayer = document.createElement('div');
                audioPlayer.className = 'audio-player';
                
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = `data:audio/wav;base64,${audioData}`;
                
                audioPlayer.appendChild(audio);
                messageContent.appendChild(audioPlayer);
                
                setTimeout(() => {
                    audio.play().catch(e => console.log('Auto-play blocked by browser'));
                }, 500);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            avatar.textContent = '🤖';
            
            const typingContent = document.createElement('div');
            typingContent.innerHTML = `
                <span>AI is thinking</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Initialize the app when page loads
        window.addEventListener('load', init);

        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && e.ctrlKey) {
                e.preventDefault();
                toggleRecording();
            }
        });
    </script>
</body>
</html>